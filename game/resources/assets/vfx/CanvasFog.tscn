[gd_scene load_steps=5 format=2]

[sub_resource type="Shader" id=1]
code = "shader_type canvas_item;

//SETTINGS//
const float timeScale = 20.0;
const float cloudScale = 0.5;
const float skyCover = 3.0; //overwritten by mouse x drag
const float softness = 0.2;
const float brightness = 1.4;
const int noiseOctaves = 8;
const float curlStrain = 3.0;

uniform sampler2D noise_texture;
uniform vec4 skyCol: hint_color = vec4(0.6,0.8,1.0,1.0);
//SETTINGS//

float saturate(float num)
{
    return clamp(num,0.0,1.0);
}

float noise(vec2 uv)
{
    return texture(noise_texture, uv).r;
}

vec2 rotate(vec2 uv)
{
    uv = uv + noise(uv*0.2)*0.005;
    float rot = curlStrain;
    float sinRot=sin(rot);
    float cosRot=cos(rot);
    mat2 rotMat = mat2(vec2(cosRot,-sinRot),vec2(sinRot,cosRot));
    return uv * rotMat;
}

float fbm (vec2 uv)
{
    float rot = 1.57;
    float sinRot=sin(rot);
    float cosRot=cos(rot);
    float f = 0.0;
    float total = 0.0;
    float mul = 0.5;
    mat2 rotMat = mat2(vec2(cosRot,-sinRot),vec2(sinRot,cosRot));
    
    for(int i = 0;i < noiseOctaves;i++)
    {
        f += noise(uv+TIME*0.00015*timeScale*(1.0-mul))*mul;
        total += mul;
        uv *= 3.0;
        uv=rotate(uv);
        mul *= 0.5;
    }
    return f/total;
}

void fragment()
{
    vec2 uv = FRAGCOORD.xy/(50000.0*cloudScale);
    
 
    float cover = 0.55; // mouseXAffect*1.1+0.1;
    //if( iMouse.z<=0.0001 ) cover = 0.5;
    
    float bright = brightness*(1.8-cover);
    
    float color1 = fbm(uv-0.5+TIME*0.00004*timeScale);
    float color2 = fbm(uv-10.5+TIME*0.00002*timeScale);
    
    float clouds1 = smoothstep(1.0-cover,min((1.0-cover)+softness*2.0,1.0),color1);
    float clouds2 = smoothstep(1.0-cover,min((1.0-cover)+softness,1.0),color2);
    
    float cloudsFormComb = saturate(clouds1+clouds2);
    
    float cloudCol = saturate(saturate(1.0-pow(color1,1.0)*0.2)*bright);
    vec4 clouds1Color = vec4(cloudCol,cloudCol,cloudCol,1.0);
    vec4 clouds2Color = mix(clouds1Color,skyCol,0.25);
    vec4 cloudColComb = mix(clouds1Color,clouds2Color,saturate(clouds2-clouds1));
    
	COLOR = mix(skyCol,cloudColComb,cloudsFormComb);
	COLOR.a = UV.y;
}"

[sub_resource type="OpenSimplexNoise" id=3]
seed = 3
octaves = 6
period = 86.7
persistence = 0.7

[sub_resource type="NoiseTexture" id=4]
width = 2048
height = 2048
seamless = true
noise = SubResource( 3 )

[sub_resource type="ShaderMaterial" id=2]
shader = SubResource( 1 )
shader_param/skyCol = Color( 0.141176, 0.141176, 0.141176, 1 )
shader_param/noise_texture = SubResource( 4 )

[node name="CanvasFog" type="CanvasLayer"]

[node name="ScreenFog" type="ColorRect" parent="."]
material = SubResource( 2 )
margin_right = 1024.0
margin_bottom = 596.0
